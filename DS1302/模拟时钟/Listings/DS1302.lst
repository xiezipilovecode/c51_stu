C51 COMPILER V9.60.7.0   DS1302                                                            07/07/2024 22:52:32 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: D:\study\embedded\program\c51\C51\BIN\C51.EXE DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND 
                    -PRINT(.\Listings\DS1302.lst) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include <REGX52.H>
   2          
   3          typedef unsigned char u8;
   4          
   5          // å®šä¹‰DS1302å¼•è„š
   6          sbit DS1302_SCLK = P3^6;
   7          sbit DS1302_IO = P3^4;
   8          sbit DS1302_CE = P3^5;
   9          
  10          // é…ç½®å‘½ä»¤
  11          #define DS1302_SECOND   0x80
  12          #define DS1302_MINUTE   0x82
  13          #define DS1302_HOUR     0x84
  14          #define DS1302_DATE     0x86
  15          #define DS1302_MONTH    0x88
  16          #define DS1302_DAY              0x8A
  17          #define DS1302_YEAR             0x8C
  18          #define DS1302_WP               0x8E
  19          
  20          u8 DSl302_Time[] = {24, 7, 4, 23, 59, 55, 4};  // å®šä¹‰æ—¥æœŸæ—¶é—´
  21          
  22          /*
  23              *  @brief  åˆå§‹åŒ–DS1302
  24              *  @param
  25              *  @retval 
  26          */
  27          void DS1302_Init(){
  28   1              // åˆå§‹åŒ–å¼•è„š
  29   1              DS1302_SCLK = 0;
  30   1              DS1302_CE = 0;
  31   1      }
  32          
  33          /*
  34              *  @brief  è¯»å–DS1302æ•°æ®
  35              *  @param  æ§åˆ¶æŒ‡ä»¤
  36              *  @retval è¿”å›è¯»å–åˆ°çš„æ•°æ®ï¼Œä¸€ä¸ªå­—èŠ‚
  37          */
  38          u8 DS1302_ReadByte(u8 command){
  39   1              u8 i, read_data=0x00;
  40   1              command |= 0x01;  // æœ€ä½ä½ä¸ºé«˜ç”µå¹³è¡¨ç¤ºè¯»æ•°æ®
  41   1              DS1302_CE = 1;
  42   1              
  43   1              // é¦–å…ˆè¯»å–å‘½ä»¤ï¼Œé«˜ç”µå¹³è§¦å‘
  44   1              for (i=0; i<8; ++i){
  45   2                      DS1302_IO = command&(0x01<<i);  // è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æŒ‡å®šä¸ºï¼Œä¾‹å¦‚ï¼Œi=2ï¼Œè¯»å–commandç¬¬äºŒä½
             -
  46   2                      DS1302_SCLK = 0;
  47   2                      DS1302_SCLK = 1;  // è¿™é‡Œå’Œå†™æ•°æ®ä¸ä¸€æ ·
  48   2              }
  49   1              
  50   1              // æ¥ä¸‹æ¥è¯»å–æ•°æ®ï¼Œä½ç”µå¹³è§¦å‘
  51   1              for (i=0; i<8; ++i){
  52   2                      DS1302_SCLK = 1;
  53   2                      DS1302_SCLK = 0;
C51 COMPILER V9.60.7.0   DS1302                                                            07/07/2024 22:52:32 PAGE 2   

  54   2                      if(DS1302_IO) {
  55   3                              read_data |= (0x01<<i);  // æŒ‡å®šä½ç½®å†™å…¥æ•°æ® 
  56   3                      }
  57   2              }
  58   1              
  59   1              DS1302_CE = 0;
  60   1              DS1302_IO = 0;
  61   1              return read_data;
  62   1      }
  63          
  64          /*
  65              *  @brief  å‘DS1302å†™å…¥æ•°æ®
  66              *  @param  æ§åˆ¶å‘½ä»¤ã€éœ€è¦å†™å…¥çš„æ•°æ®
  67              *  @retval 
  68          */
  69          void DS1302_WriteByte(u8 command, u8 write_data){
  70   1              u8 i;
  71   1              DS1302_CE = 1;
  72   1              // é¦–å…ˆè¯»å–å‘½ä»¤ï¼Œé«˜ç”µå¹³è§¦å‘
  73   1              for (i=0; i<8; ++i){
  74   2                      DS1302_IO = command&(0x01<<i);  // è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æŒ‡å®šä¸ºï¼Œä¾‹å¦‚ï¼Œi=2ï¼Œè¯»å–commandç¬¬äºŒä½
             -
  75   2                      DS1302_SCLK = 1;
  76   2                      DS1302_SCLK = 0;
  77   2              }
  78   1              
  79   1              // æ¥ä¸‹æ¥å†™å…¥æ•°æ®ï¼Œé«˜ç”µå¹³è§¦å‘
  80   1              for (i=0; i<8; ++i){
  81   2                      DS1302_IO = write_data&(0x01<<i);
  82   2                      DS1302_SCLK = 1;
  83   2                      DS1302_SCLK = 0;
  84   2              }
  85   1              DS1302_CE = 0;
  86   1      }
  87          
  88          /*
  89          *  @brief  8421ç è½¬ä¸ºåè¿›åˆ¶ï¼Œè¿™é‡Œé€‚ç”¨äºä¸¤ä½çš„BCDç 
  90          *  @param  Data:BCDç ï¼Œmode: 0/1  modeä¸º0è¡¨ç¤ºBCDç è½¬åè¿›åˆ¶ï¼Œåä¹‹ä¸ºåè¿›åˆ¶è½¬ä¸ºBCDç 
  91          *  @retval  è½¬æ¢ä¸ºåè¿›åˆ¶çš„BCDç 
  92          */
  93          u8 Code8421_Decimal(unsigned char Data, mode){
  94   1              unsigned char result;
  95   1              if (mode)  result = Data / 16 * 10 + Data % 16;
  96   1              else result = (Data / 10) * 16 + Data % 10;
  97   1              return result;
  98   1      }
  99          
 100          /*
 101          *  @brief  ä¸ºDS1302è®¾ç½®åˆå§‹æ—¥æœŸæ—¶é—´
 102          *  @param
 103          *  @retval 
 104          */
 105          void DS1302_SetTime(){
 106   1              // è®¾ç½®æ—¶é—´
 107   1              DS1302_WriteByte(DS1302_WP, 0x00);  // æ‰“å¼€å†™ä¿æŠ¤
 108   1              // å¹´æœˆæ—¥æ—¶åˆ†ç§’æ˜ŸæœŸè®¾ç½®
 109   1              DS1302_WriteByte(DS1302_YEAR, Code8421_Decimal(DSl302_Time[0], 0));
 110   1              DS1302_WriteByte(DS1302_MONTH, Code8421_Decimal(DSl302_Time[1], 0)); 
 111   1              DS1302_WriteByte(DS1302_DAY, Code8421_Decimal(DSl302_Time[2], 0));
 112   1              DS1302_WriteByte(DS1302_HOUR, Code8421_Decimal(DSl302_Time[3], 0));
 113   1              DS1302_WriteByte(DS1302_MINUTE, Code8421_Decimal(DSl302_Time[4], 0));
 114   1              DS1302_WriteByte(DS1302_SECOND, Code8421_Decimal(DSl302_Time[5], 0));
C51 COMPILER V9.60.7.0   DS1302                                                            07/07/2024 22:52:32 PAGE 3   

 115   1              DS1302_WriteByte(DS1302_DATE, Code8421_Decimal(DSl302_Time[6], 0));
 116   1              DS1302_WriteByte(DS1302_WP, 0x80);  // å…³é—­å†™ä¿æŠ¤
 117   1      }
 118          
 119          /*
 120          *  @brief  è¯»å–DS1302ä¸­çš„å½“å‰æ—¥æœŸæ—¶é—´
 121          *  @param
 122          *  @retval 
 123          */
 124          void DS1302_ReadTime() {
 125   1              // è¯»å–æ•°æ®ä¿å­˜åˆ°æ•°ç»„ä¸­ï¼Œè¿™é‡Œå°†BCDç è½¬ä¸ºåè¿›åˆ¶ï¼Œæ–¹ä¾¿æ˜¾ç¤º
 126   1              DSl302_Time[0] = Code8421_Decimal(DS1302_ReadByte(DS1302_YEAR), 1); 
 127   1              DSl302_Time[1] = Code8421_Decimal(DS1302_ReadByte(DS1302_MONTH), 1); 
 128   1              DSl302_Time[2] = Code8421_Decimal(DS1302_ReadByte(DS1302_DAY), 1); 
 129   1              DSl302_Time[3] = Code8421_Decimal(DS1302_ReadByte(DS1302_HOUR), 1); 
 130   1              DSl302_Time[4] = Code8421_Decimal(DS1302_ReadByte(DS1302_MINUTE), 1); 
 131   1              DSl302_Time[5] = Code8421_Decimal(DS1302_ReadByte(DS1302_SECOND), 1); 
 132   1              DSl302_Time[6] = Code8421_Decimal(DS1302_ReadByte(DS1302_DATE), 1); 
 133   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    379    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
